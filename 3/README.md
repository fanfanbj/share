#分布式环境中配置管理的学问
距离上次动笔已经一个月了，当时我觉得我会写一篇容器网络的文章，因为一直在恶补网络相关的知识，与其说恶补，不如说重新系统学习，完全沉浸于此，却一直觉得这块博大精深，下笔无彩。到现在为止，估计大部分知识已经退还给各个原作者，知识的积累还是需要落地实践的沉淀。其间，公司自研项目中，我被推进一个“大大坑”中，负责构建发布与配置管理。指导思想是Google的发布系统Rapid及《Google SRE运维解密》和CEO王总。

##客户的需求
构建发布与配置管理是一个考验研发工程师挑战产品经理的机会。第一次和CEO王总聊需求，他的角色像产品经理，他告诉我，他的需求是：”按照Google的Borg思路实现数人云Paas平台，为企业客户带来正宗的Borg体验。可以去看看《Google SRE运维解密》的第八章与第二十七章，Over～“，看完SRE相应的章节后，我更是困惑，我们难道要实现一个Jenkins？于是，不知所云的我，在PRD初稿上写道：“本功能关注于软件构建和交付，完成软件生命周期中的构建，测试，打包及部署。初期设计原则要遵循Google的发布工程哲学，发布流程要一致，可重复，密闭，可靠。” 但具体做啥？去实现一个Jenkins完成构建，测试，打包，发布一套发布功能吗？Drone不是一个基于Golang写得轻量级的CI服务器吗？王总看了我的PRD后，又把我叫到办公室，这一谈，就是两个多小时，出来后，同桌说：”你们聊那么久，我还以为你被开了呢？“囧2。我们聊了什么，这次，王总告诉我，咱们用Jenkins做CI服务器，我们做构建发布工具。天空上飘来几个字：”什么？Jenkins不就是做构建发布的嘛？“之后，王总说，我们要支持Cherry pick等Google的思想，因为他接触的广发客户代码管理非常混乱，他觉得做这件事儿是有意义的。我充满了疑惑，直到谈话结束，我说我回去再好好想想。其实，我已经晕了，我们到底要做啥呢？

谈话结束后，前端售前又抛了一颗重弹：“我们不需要自研一个构建和发布工具，围绕jenkins做一些插件开发，即可满足我们的需求，相反， 配置中心是我们目前非常紧迫的一个需求，而且配置中心在未来一定也是我们产品中一个非常核心的部分。”
前端抛给我配置中心的需求如下：

这个需求我目前看到的有两种场景

场景1： 历史应用：应用通过配置文件管理配置信息，开发，测试，生产有不同的配置文件。
这种场景是最常见的场景，关于这种场景，我认为比较好的做法其实就是目前广发在推行的方案： 流程如下

1. 通过CI生成 应用基础镜像，这个镜像里边没有配置文件，或者使用开发环境的配置文件
2. 使用测试环境的配置文件覆盖应用基础镜像中的配置文件，生成测试镜像
3. 同理，生成生产环境镜像

场景2：新的应用：完全新的产品，在设计上用户很愿意接受合作伙伴的意见
我理解在这种情况下，我们应该建议客户使用我们的配置中心方案进行产品设计

这种情况下，给我们带来的好处是非常明显的， 简单来说

1. 对docker应用而言，配置中心是一个必须的产品，如果没有配置中心进行配置管理，那么就一定会遇到上面这种尴尬的场景
2. 随着配置中心方案的成熟，配置中心会逐渐形成一个产品，这样随着以后我们客户增多，也就少了很多定制开发的功能

对于客户需求，总结他们的诉求，思考自己的产品，同时还要找到一个平衡，如何在有限的时间内交付一个客户需要的产品。

##再谈客户的需求与诉求
客户的需求或诉求是基于他当前的认知，做为新技术创业公司，用自己的专业知识，思维，产品设计给客户“洗脑”，带给客户更先进的产品与体验。
比如：前端总结的客户需求如下：
1. 通过jenkins插件完成为每一个测试环境，生产环境生成对应镜像的需求。大概流程如下：
![image](https://github.com/fanfanbj/share/blob/master/3/jenkins.jpg)

2.  请基于jenkins 开发一个持续部署的功能，可以参考目前jenkins的插件 Deploy to container （建议方案： 调用目前数人云平台上的应用发布接口实现）

配置管理初稿，我是基于这些前端输入而设计的。有两个思路：第一种思路是：不同环境生成不同的镜像，每个镜像中包括不同的配置文件。第二思路是：一个程序镜像，启动容器时拉取不同环境的配置文件。我认为第二种要比第一种要更先进些。但是，当我看了两篇配置中心的文章：《一篇好TM长的关于配置中心的文章》及《etcd和confd实现nginx配置文件自动管理》，我对分布式环境中配置中心的概念，它所能解决的问题，有了重新的认识。经过思考也改变了我最初的设计。我更愿意将配置中心这个新的理念带到客户的Paas平台中。

还有一件事情，在我和客户交流的时候，客户问我：“以前传统应用是要保证事务的一致性，服务的可用性及深思熟虑的容错性。现在好像Paas平台上容器应用可以停止，再拉起新的容器应用。” 我当时的回答是：“是的。”，之后跟客户聊了半天容器应用监控等事情。因为配置管理的研究，我开始深入的了解分布式系统。知道了CAP原则和BASE原则，那么对于一致性，可用性，及分区容错性。一个分布式系统不能同时满足一致性，可用性和分区容错性这三个需求。如果当时，我的知识积累到达这个高度，我完全可以给出更好的答案。“镇住“”客户。只是，面对新技术，很多时候，前端的工程师是和客户一起成长的。

##Google的配置管理
Google的配置管理在《Google SRE运维解密》中只是一笔提到了Google分发配置文件模型，并提及将配置文件存放于我们的主要代码仓库中,同时进行严格的代码评审过程。Google配置管理是在编排文件里加入各种命令行参数，然后把编排文件放到代码库。发布应用的时候，Borg可以从代码库下载编排文件或手动给Borg上传编排文件。Borg解析编排文件之后，把命令行参数配好，然后启动应用实例。显然，Google面向的应用都是Google内部的应用，有统一的规约，配置文件就是编排文件，并以ENV形式加载在应用容器里。那么面对复杂的客户应用，这样模仿显然无法满足需求。

##配置中心的雏形
下面是我对配置中心的设计雏形，此设计参考了confd和etcd的实现。

1. 实现一个配置文件分发中心，解决静态配置的需求。
2. 对于动态配置，我们可以自研配置中心，提供此方面的解决方案给客户。（注：配置变更只发生在软件版本构建和发布的那个点，那么就是静态配置。）
3. 初步方案是参考confd和etcd的实现。将一些可变的配置信息push到etcd中。（包括代码Revision或二进制文件的版本，镜像Tag等配置信息。）confd 设置模版 （开发环境，测试环境，生产环境有不同的模版），通过etcd获取指定配置信息，生成最新配置文件。推送最新的配置文件到配置文件分发中心。为发布应用做准备。
4. 通过调度器下载变化的配置项，支持动态配置加载。 
 
在写这篇文章的时候，同事发给我普元“业务配置集中管理”的架构图。基本能反映我心目中对配置中心的设计：

![image](https://github.com/fanfanbj/share/blob/master/3/puyuan.jpeg)

